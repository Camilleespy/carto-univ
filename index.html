<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cartographie historique des universités en Europe</title>

  <meta name="description" content="Cartographie historique des universités en Europe">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.css" media="screen" title="no title" charset="utf-8">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />

  <style>

    body {
      font-family: 'Roboto', sans-serif;
      font-size: 12pt;
    }

    h1 {
      font-weight: 400;
      padding: 0 0 0 5%;
    }

    #selector {
      padding: 0 5%;
      width: 90%;
      position: absolute;
      bottom:40px
    }

    #caption {
      position: fixed;
      z-index :1000;
      background-color: rgba(0,0,0,.3)
    }

    #map {
      height: 70%;
      width: 100%;
      margin-left: 250px;
      position: absolute;
      display: block;
    }

  </style>

</head>
<body>

  <h1>Cartographie historique des universités en Europe</h1>
  <div id="main">
    <div id="map"></div>
    <svg id="caption"></svg>
  </div>

  <div id="selector">
    <p>Année : <span id="year">year</span></p>
    <div id="slider"></div>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.js
  " charset="utf-8"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.3/d3-queue.js" charset="utf-8"></script>

  <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

  <script>

    /*
    * TODO
    *
    * - OK: fix geoloc
    * - OK: montrer seulement ce qu'il y a dans les données
    * - OK: dates de fondation
    * - OK titre
    * - OK (Eric): nettoyage des données
    * - échelle
    */

    // setup map
    let map = L.map('map').setView([51.505, -0.09], 4);

    let url = 'http://tile.thunderforest.com/transport/{z}/{x}/{y}.png'
    let attribution = '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'

    L.tileLayer(url, {
        attribution: attribution,
        minZoom: 0,
      	maxZoom: 20,
      	ext: 'png'
    }).addTo(map)

    // Created a layer to put all our markers
    const markersLayer = new L.LayerGroup()
    markersLayer.addTo(map)


    // load all needed files
    d3.queue()
      .defer(d3.json, "docs/legend.json")
      .defer(d3.json, "data/geocodes-final.json")
      .defer(d3.dsv("\t"), "./docs/Tout-Univ-religion-par-an.csv")
      .await(function(error, legend, coords, rawData) {
          if (error) throw error
          console.log("data loaded")

          // TODO : fix cities names
          // console.log("--- TODO :fix cities");
          // let cities = rawData.map(d => d["Univ"])
          // let coordsCities = Object.keys(coords)
          // cities.forEach(d => { if (! coords[d]) {
          //   console.log(d)
          // } else {
          //   let index = coordsCities.indexOf(d)
          //   if (index > -1) coordsCities.splice(index, 1)
          // }
          // })
          // console.log(coordsCities)

          // draw caption
          initCaption(legend)

          // merge all data into a single object
          let data = rawData.map( d => {
            let name = d["Univ"],
              latLng = coords[ name ]

            let years = {}
            Object.keys(d).forEach( y => {
              let value = (years[y] == '0') ? null : legend[d[y]]
              years[y] = value
            })

            return {
              name,
              latLng,
              years
            }
          })

          // get all years
          const years = Object.keys(rawData[0]).map(d => parseInt(d) )
          let now = d3.min(years)
          // let endYear = d3.max(years)
          d3.select("#year").text(now)

          // create slider
          const slider = document.getElementById('slider')

          noUiSlider.create(slider, {
          	start:  now, //[startYear, endYear],
          	connect: true,
            step: 20,
          	range: {
          		'min': d3.min(years),
          		'max': d3.max(years)
          	},
            pips: {
              mode: 'count',
              values: 10,
              density: 1,
              stepped: true
            }
          })

          // show slider value on the page
          slider.noUiSlider.on('slide', value => {
            let now = Math.floor(value)
            // let end = Math.floor(value[1])

            // compute list of valid years
            // let yearList = getYearList(years, start, end )

            d3.select("#year").text(now)

            // update display
            updateMarkers(data, now)

            // update counts in caption
            updateCaption(data, now, legend)
          })

          // log number of results
          console.log(data.length, 'results')

          // init visual rendering on map
          // let yearList = getYearList(years, startYear, endYear )
          updateMarkers(data, now)

          // update counts in caption
          updateCaption(data, now, legend)

      });


  function getYearList(years, start, end) {
    let yearList = []
    years.forEach(y => { if (y >= start && y <= end) yearList.push(y) })
    return yearList
  }

  function initCaption(legend) {

    // draw caption
    let captions = d3.select("#caption")
      .attr("width", 250)
      .attr("height", 300)
      .selectAll(".caption")
        .data(Object.keys(legend).map(d => legend[d]))
        .enter()
      .append("g")
        .attr("class", "caption")
        .attr("transform", (d,i) => "translate(20,"+(i*30+20)+")")

    captions.append("circle")
        .attr("r", 10)
        .attr("class", d => d.color )
        .style("fill", d => d.color )

    captions.append("text")
      .attr("text-anchor", "left")
      .attr("x", 20)
      .attr("y", 5)
      .text(d => d.nom)

  }

  function updateCaption(data, year, legend) {

    // count occurence
    let counts = {}
    data.forEach(d => {
      if (d.years[year]) {
        let abbr = d.years[year].abbr
        counts[abbr] = counts[abbr] ? counts[abbr]+1 : 1;
      }
    })

    let countsWithInfo = Object.keys(legend).map(d => Object.assign( legend[d], { count : counts[d]}) )

    d3.selectAll(".caption")
      .data(countsWithInfo)
        .select("text")
      .attr("fill", d => d.count ? "white" : "rgba(0,0,0,.5)" )
      .text(d => d.count ? d.nom + "("+d.count+")" : d.nom )

  }


  function updateMarkers(data, year){
    // console.log("updated :" + yearList.length + ' valid dates from '+ d3.min(yearList) +" to "+ d3.max(yearList))

    // The first thing we do here is clear the markers from the layer.
    markersLayer.clearLayers()

    // parse values for a specific year
    let values = []
    data.forEach(d => {
      if(d.years[year]) { // check if there is a value in the year
        let value = {
          name : d.name,
          latLng : d.latLng,
          year : year,
          data: d.years[year]
        }
        values.push(value)
      }
    })

    // console.log(values);
    /*
    * NOW LET'S DRAW STUFF !
    */

    // calculate scale
    // let counts = values.map(v => v.count)
    // let scale = d3.scale
    //     .linear()
    //     .domain([d3.min(counts),d3.max(counts)])
    //     .range([10000, 400000])

    // create an array to store our markers
    let circles = values.map( d => {
      // console.log(Math.floor(scale(d.count)))
      return L.circle(d.latLng, {
          fillColor: d.data.color,
          color: d.data.color,
          fillOpacity: 0.5,
          weight: 1,
          radius: 3000 //Math.floor(scale(d.count))
      })
      .bindPopup(d.name, { showOnMouseOver: true })
    })

    // console.log(circles.length)
    let markers = L.featureGroup(circles)

    // add markers to map
    markersLayer.addLayer(markers)

    map.fitBounds(markers.getBounds())
    markers.bringToFront()

  }

  </script>
</body>
