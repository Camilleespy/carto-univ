<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cartographie historique des universités en Europe</title>

  <meta name="description" content="Cartographie historique des universités en Europe">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.css" media="screen" title="no title" charset="utf-8">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />

  <style>

    body {
      font-family: 'Roboto', sans-serif;
      font-size: 12pt;
    }

    h1 {
      font-weight: 400;
      padding: 0 0 0 5%;
    }

    #selector {
      padding: 0 5%;
      width: 90%;
      position: absolute;
      bottom:40px
    }

    #map {
      height: 70%;
      width: 100%;
      position: absolute;
      display: block;
    }

  </style>

</head>
<body>


  <h1>Cartographie historique des universités en Europe</h1>
  <div id="map"></div>


  <div id="selector">
    <p>Année : <span id="year">year</span></p>
    <div id="slider"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.js
  " charset="utf-8"></script>
  <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>


  <script>


    /*
    * TODO
    *
    * - OK: fix geoloc
    * - OK: montrer seulement ce qu'il y a dans les données
    * - OK: dates de fondation
    * - OK titre
    * - échelle
    * - Eric: nettoyage des données
    */

    // setup map
    let map = L.map('map').setView([51.505, -0.09], 4);

    let url = 'http://tile.thunderforest.com/transport/{z}/{x}/{y}.png'
    let attribution = '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'

    L.tileLayer(url, {
        attribution: attribution,
        minZoom: 0,
      	maxZoom: 20,
      	ext: 'png'
    }).addTo(map)

    // Created a layer to put all our markers
    const markersLayer = new L.LayerGroup()
    markersLayer.addTo(map)

    // load geo coordinates
    d3.json("data/geocodes-final.json", geoData => {

      // compute geo coordinates
      const coords = {}
      Object.keys(geoData).forEach( (d,i) => {
        // let geo = geoData[d]
        // if(geo.lat && geo.lng) coords[d] = [geo.lat, geo.lng]
        coords[d] = geoData[d]
      })

      // load data
      d3.csv("data/universites.csv", rawData => {

        // get all years
        const years = Object.keys(rawData[0]).map(d => parseInt(d) )
        let startYear = d3.min(years)
        let endYear = d3.max(years)
        d3.select("#year").text(startYear + "-" + endYear)

        // create slider
        const slider = document.getElementById('slider')

        noUiSlider.create(slider, {
        	start: [startYear, endYear],
        	connect: true,
          step: 20,
        	range: {
        		'min': d3.min(years),
        		'max': d3.max(years)
        	},
          pips: {
            mode: 'count',
            values: 10,
            density: 1,
            stepped: true
          }
        })

        // show slider value on the page
        slider.noUiSlider.on('slide', value => {
          let start = Math.floor(value[0])
          let end = Math.floor(value[1])

          // compute list of valid years
          let yearList = getYearList(years, start, end )
          updateMarkers(data,yearList)

          d3.select("#year").text(start + "-" +end)

        })

        // parse our data
        const toBeRemoved = ["J : collège jésuites", "Est : Estimation", "M : matricules", "", "R : rotuli"]

        let data = []
        rawData.forEach(d => {
          let name = d["Université"]
          if ( ! toBeRemoved.indexOf(name) > -1 ) {
            let values = {
              name : name,
              founded : parseInt(d["Date de fondation"]),
              years : {},
              latlng: coords[name]
            }

            Object.keys(d).forEach(year => {
              let point = { year: year, count : null, type : null}
              let split = d[year].split(":")
              if(split.length > 1) {
                point.type = split[0]
                point.count = parseInt(split[1])
              }
              values.years[year] = point
            })
            data.push(values)
          }
        })

        // log number of results
        console.log(data.length, 'results')

        // init visual rendering on map
        let yearList = getYearList(years, startYear, endYear )
        updateMarkers(data,yearList)

      })
    })

    function getYearList(years, start, end) {
      let yearList = []
      years.forEach(y => { if (y >= start && y <= end) yearList.push(y) })
      return yearList
    }


  function updateMarkers(data, yearList){
    // console.log("updated :" + yearList.length + ' valid dates from '+ d3.min(yearList) +" to "+ d3.max(yearList))

    // The first thing we do here is clear the markers from the layer.
    markersLayer.clearLayers()

    // store all data values
    let values = []

    // Then we loop through our data to calculate all values
    data.forEach(d => {

      // sum of all count in the valid years
      let count = d3.sum(yearList.map(year =>  d.years[year].count ))

      // // new univ are in green
      d.color = (d.created == d3.min(yearList)) ? 'green' : 'red'

      // check if there is a value
      if (count || d.created == d3.min(yearList)) {
        // store value
        d.count = count
        values.push(d)
      }
    })

    /*
    * NOW LET'S DRAW STUFF !
    */

    // calculate scale
    let counts = values.map(v => v.count)
    let scale = d3.scale
        .linear()
        .domain([d3.min(counts),d3.max(counts)])
        .range([10000, 400000])

    // create an array to store our markers
    let circles = values.map( d => {
      // console.log(Math.floor(scale(d.count)))
      return L.circle(d.latlng, {
          color: d.color,
          fillColor: '#f03',
          fillOpacity: 0.5,
          weight: 1,
          radius: Math.floor(scale(d.count))
      })
      .bindPopup(d.name, { showOnMouseOver: true })
    })

    // console.log(circles.length)
    let markers = L.featureGroup(circles)

    // add markers to map
    markersLayer.addLayer(markers)

    map.fitBounds(markers.getBounds())
    markers.bringToFront()

  }

  </script>
</body>
